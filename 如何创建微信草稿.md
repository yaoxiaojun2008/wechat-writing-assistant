# 如何创建微信草稿

## 概述

本文档总结了创建微信公众号草稿的正确方法，特别是如何处理图片素材和避免常见的错误。

## 正确的创建流程

### 1. 上传图片素材

首先，必须通过素材管理API上传所有需要的图片：

```python
# 上传图片素材
upload_url = f"https://api.weixin.qq.com/cgi-bin/material/add_material?access_token={access_token}&type=image"
with open(image_path, 'rb') as f:
    files = {'media': f}
    response = requests.post(upload_url, files=files)
```

### 2. 获取素材ID

上传成功后，获取返回的`media_id`：

```python
result = response.json()
if 'media_id' in result:
    media_id = result['media_id']
    print(f"✅ 图文素材上传成功，素材ID: {media_id}")
```

### 3. 上传图文消息内的图片

对于在文章内容中显示的图片，需要使用专门的接口上传：

```python
# 上传图文消息内的图片（用于content内容中）
upload_img_url = f"https://api.weixin.qq.com/cgi-bin/media/uploadimg?access_token={access_token}"
with open(image_path, 'rb') as f:
    files = {'media': f}
    response = requests.post(upload_img_url, files=files)
    result = response.json()
    if 'url' in result:
        img_url = result['url']
        print(f"✅ 图文消息图片上传成功，URL: {img_url}")
```

### 4. 在内容中使用图片URL

在content中使用返回的图片URL，而不是media_id：

```python
content_with_image = f"<p>文章内容</p><img src='{img_url}' alt='图片'><p>更多内容</p>"
```

### 5. 使用素材ID创建草稿

在创建草稿时，使用预先上传的素材ID作为封面图：

```python
draft_data = {
    "articles": [{
        "title": "草稿标题",
        "author": "作者",
        "digest": "摘要",
        "content": content_with_image,  # 使用包含图片URL的内容
        "content_source_url": "",
        "thumb_media_id": media_id,  # 封面图使用media_id
        "show_cover_pic": 0,
        "need_open_comment": 0,
        "only_fans_can_comment": 0
    }]
}

response = requests.post(
    f"https://api.weixin.qq.com/cgi-bin/draft/add?access_token={access_token}",
    data=json.dumps(draft_data, ensure_ascii=False).encode('utf-8'),
    headers={'Content-Type': 'application/json; charset=utf-8'}
)
```

## 使用项目中的配置和图片

### 配置文件

项目使用 `.env` 文件存储微信API配置：

```
# 微信API配置
WECHAT_APP_ID = "wx7829dcea67e05a04"
WECHAT_APP_SECRET = "878b604f3c2b32c4a918b406c089c543"
```

### 图片资源

项目中的图片存储在 `img/` 目录中，包含多种格式的图片文件。

### 完整测试脚本

我们创建了一个完整的测试脚本 `test_image_upload_workflow.py`，该脚本：

1. 从 `.env` 文件加载配置
2. 扫描 `img/` 目录中的图片文件
3. 按照正确的流程上传图片素材
4. 创建包含图片的草稿

## 常见错误及解决方案

### 错误1: 错误码40007 ("invalid media_id")

- **原因**: 这个错误码通常不是真正的"媒体ID无效"，而是误导性错误
- **可能原因**:
  - 公众号类型限制（个人订阅号可能不支持草稿箱功能）
  - 账号权限不足
  - 账号未认证

### 错误2: 错误码41005 ("media data missing")

- **原因**: 在创建图文素材时，试图直接在内容中使用图片URL，而不是使用预先上传的素材ID
- **解决方案**: 必须先上传图片素材，然后在创建草稿时引用素材ID

### 错误3: 内容中显示图片ID而不是图片

- **原因**: 在content字段中直接使用了media_id，而不是图片URL
- **解决方案**: 
  - 使用`/cgi-bin/media/uploadimg`接口上传内容中的图片
  - 在content中使用返回的URL，而非media_id
  - 仅在thumb_media_id字段中使用media_id（作为封面图）

## 关键要点

1. **分步处理**: 必须先上传图片素材，获取素材ID，然后在创建草稿时使用该ID
2. **封面图与内容图的区别**: 
   - 封面图(thumb_media_id)使用通过`/cgi-bin/material/add_material`获得的media_id
   - 内容中的图片使用通过`/cgi-bin/media/uploadimg`获得的URL
3. **不能一步到位**: 草稿API不支持在创建草稿的同时上传图片素材
4. **权限检查**: 确保公众号类型支持草稿箱功能（通常需要认证服务号）
5. **编码处理**: 确保发送的数据使用UTF-8编码

## 代码示例

```python
# 完整的创建草稿流程
def create_draft_with_image(access_token, image_path, article_data):
    # 步骤1: 上传封面图片素材
    thumb_media_id = upload_permanent_image(access_token, image_path)
    if not thumb_media_id:
        return None
    
    # 步骤2: 上传内容中的图片
    content_img_url = upload_content_image(access_token, image_path)
    if not content_img_url:
        return None
    
    # 步骤3: 构建包含图片URL的内容
    content_with_img = f"<p>文章内容</p><img src='{content_img_url}' alt='内容图片'>"
    
    # 步骤4: 使用素材ID创建草稿
    article_data['thumb_media_id'] = thumb_media_id
    article_data['content'] = content_with_img
    
    return create_draft(access_token, article_data)

def upload_permanent_image(access_token, image_path):
    """上传永久图片素材，用于封面图"""
    upload_url = f"https://api.weixin.qq.com/cgi-bin/material/add_material?access_token={access_token}&type=image"
    with open(image_path, 'rb') as f:
        files = {'media': f}
        response = requests.post(upload_url, files=files)
        
    result = response.json()
    if 'media_id' in result:
        return result['media_id']
    else:
        print(f"❌ 上传永久素材失败: {result}")
        return None

def upload_content_image(access_token, image_path):
    """上传图文消息内的图片，用于content内容"""
    upload_img_url = f"https://api.weixin.qq.com/cgi-bin/media/uploadimg?access_token={access_token}"
    with open(image_path, 'rb') as f:
        files = {'media': f}
        response = requests.post(upload_img_url, files=files)
        
    result = response.json()
    if 'url' in result:
        return result['url']
    else:
        print(f"❌ 上传内容图片失败: {result}")
        return None

def create_draft(access_token, article_data):
    draft_data = {"articles": [article_data]}
    
    response = requests.post(
        f"https://api.weixin.qq.com/cgi-bin/draft/add?access_token={access_token}",
        data=json.dumps(draft_data, ensure_ascii=False).encode('utf-8'),
        headers={'Content-Type': 'application/json; charset=utf-8'}
    )
    
    return response.json()
```

## 测试验证

使用以下测试脚本验证草稿创建功能：

```python
# 测试脚本
python test_image_upload_workflow.py
```

## 参考

- [微信公众号开发文档 - 草稿箱](https://developers.weixin.qq.com/doc/offiaccount/Asset_Management/New_temporary_materials.html)
- [微信公众号开发文档 - 素材管理](https://developers.weixin.qq.com/doc/offiaccount/Asset_Management/Adding_Permanent_Assets.html)
- [微信公众号开发文档 - 上传图文消息内的图片](https://developers.weixin.qq.com/doc/offiaccount/Asset_Management/Upload_img_to_get_URL.html)